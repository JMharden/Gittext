<?phpnamespace Home\Controller;use Think\Controller;/** * * 第三方支付集合 * */class PayController extends HomeController {    protected $money,$out_trade_no;	public function _initialize()    {		parent::_initialize();		/*if (CONTROLLER_NAME == 'Pay') {			$param = array(				'out_trade_no' => $_GET['out_trade_no'],				'money' => $_GET['money'],				'name' => $_GET['name'],				'callback' => $_GET['callback'],				'sign' => $_GET['sign']			);			$check_sign = check_url_sign($param);			if (!$check_sign) {				die('支付地址无效');			}		}*/		$this -> out_trade_no = $_GET['orderNo'];		$this -> money = $_GET['money'];        // $this -> name = empty($_GET['name']) ? $this -> _site['name'].'在线支付' : $_GET['name'];        $this -> name = '游戏币充值';	}	public function hx_pay()    {        /*$host_url='https://shq-api.51fubei.com/gateway';        if (empty($this->user['popenid'])) {            //获取popenid            $pay_data['money']=I('money');            $pay_data['orderNo']=I('orderNo');            session('pay_data',$pay_data);            $p=array();            $p['app_id']=C('hx_pay.app_id');            $p['method']='openapi.payment.auth.auth';            $p['nonce']=C('hx_pay.nonce');            $p['format']='json';            $p['sign_method']='md5';            $p['biz_content']=array(                'url'=>'http://'.$_SERVER['HTTP_HOST'].'/hx_login.php',            );            $p['biz_content']=json_encode($p['biz_content']);            ksort($p);            $str='';            foreach($p as $k=>$v){                $str .= '&'.$k.'='.$v;            }            $str=substr($str,1);            $p['sign']=md5($str.C('hx_pay.key'));            $p['sign']=strtoupper($p['sign']);            $res=send_post($host_url,json_encode($p));            $res=(array)json_decode($res);            if($res['result_code']==200){                header('location:'.$res['data']->authUrl);            }            die();        }        $add['user_id']= $this->user['id'];        $add['money'] = round(($this->money/100),2);        $add['remark'] = $this->out_trade_no;        $add['create_time'] = time();        $add['chou']=1;        $add['status']=0;        M('charge_log')->add($add);        $p=array();        $p['app_id']=C('hx_pay.app_id');        $p['method']='openapi.payment.order.h5pay';        $p['nonce']=C('hx_pay.nonce');        $p['format']='json';        $p['sign_method']='md5';        $p['biz_content']=array(            'merchant_order_sn'=>$this->out_trade_no,            'open_id'=>$this->user['popenid'],            'sub_open_id'=>$this->user['sub_openid'],            'total_fee'=>$add['money'],            'store_id'=>C('hx_pay.store_id'),        );//        echo '<pre>'; var_dump($p); die();        $p['biz_content']=json_encode($p['biz_content']);        ksort($p);        $str='';        foreach($p as $k=>$v){            $str .= '&'.$k.'='.$v;        }        $str=substr($str,1);        $p['sign']=md5($str.C('hx_pay.key'));        $p['sign']=strtoupper($p['sign']);        $res=send_post($host_url,json_encode($p));        $res=(array)json_decode($res);        if($res['result_code']==200){            $back_url='http://'.$_SERVER['HTTP_HOST'].'/index.php';            $cancel_url='http://'.$_SERVER['HTTP_HOST'].'/index.php';            $url = "https://shq-api.51fubei.com/paypage";            $url .='?prepay_id='.$res['data']->prepay_id.'&callback_url='.$back_url.'&cancel_url='.$cancel_url;            header('Location:'.$url);        }else{            $this->error($res['result_message'],U('Index/index'));        }*/    }    public function hx_pay_old()    {        die();        // amount=1&channelFlag=01&merNo=999310156610001&orderNo=12345678902& termNo=00000090        $add['user_id']= $this->user['id'];        $add['money'] = round(($this->money/100),2);        $add['remark'] = $this->out_trade_no;        $add['create_time'] = time();        $add['chou']=1;        $add['status']=0;        M('charge_log')->add($add);        $api_url='http://scp.yufu99.com/scanpay-api/api/wxGZHUnifiedOrder20';        $param['merNo']='MS0000001730988';        // $param['merNo']='MS0000001717234';        $param['orderNo']=$this->out_trade_no;        $param['amount']=$this->money;        $param['reqId']=$param['orderNo'];        $param['reqTime']=date('YmdHis',time());        $param['subAppId']=$this->_mp['appid'];        $param['subOpenId']=$this->user['openid'];        $param['notifyUrl']='http://'.$_SERVER['HTTP_HOST'].'/wx_notify.php';        $key='fdb2841c18114a14b283c15cf8dc47b1';        // $param['goodsName']='游戏币充值'. $_SESSION['user']['id'];        ksort($param);        // echo '<pre>';        $str='';        foreach ($param as $k=>$v) {           $str .= '&'.$k.'='.$v;        }        $str=substr($str,1);        $param['signIn']=md5($str.$key);        // $param['signIn']=md5(http_build_query($param).$key);        $param['signIn']=strtoupper($param['signIn']);        $res=send_post($api_url,http_build_query($param));        $res=(array)json_decode($res);        $this->assign('param',$res);        $this->display();    }	// 微信支付	function wxpay()    {        die();		$jsapi = new \Common\Util\wxjspay;		$param = $this -> _pay_mp;		$param['key'] = $this -> _pay_mp['key'];		$param['openid'] = $this -> user['bopenid'];		$param['body'] = $this -> name . $_SESSION['user']['id'];		$param['out_trade_no'] = $this -> out_trade_no;		$param['total_fee'] = $this -> money;		$param['notify_url'] = "http://".$_SERVER['HTTP_HOST'].__ROOT__.'/wx_notify.php';		$jsapi -> set_param($param);		$uo = $jsapi -> unifiedOrder(IS_WECHAT ? 'JSAPI' : 'NATIVE');		// 发生错误则提示		if (!$uo) {			$this -> error($jsapi -> errmsg);		}		// 微信中发起支付		$prepay_id = $uo['prepay_id'];		$jsapi_params = $jsapi -> get_jsApi_parameters();		$this -> assign('jsApiParameters', $jsapi_params);				// 支付成功之后跳转地址		$this -> assign('callback',$_GET['callback']);		$this -> display();	}		// 支付宝支付	public function alipay()    {        die();		if (IS_WECHAT && empty($_GET['iframe'])) {			$_GET['iframe'] = 1;			$url = U(null,$_GET);			$this -> assign('url',$url);			$this -> display();			exit;		}		$alipay_config = $this -> _alipay;		$parameter = array(			"service"       => IS_MOBILE ? 'alipay.wap.create.direct.pay.by.user' : 'create_direct_pay_by_user',			"partner"       => $this -> _alipay['pid'],			"seller_id"  	=> $this -> _alipay['pid'],			"payment_type"	=> 1,			"notify_url"	=> complete_url('/alipay_notify.php'),			"return_url"	=> complete_url($_GET['callback']),			"anti_phishing_key"=> '',			"exter_invoke_ip"=> '',			"out_trade_no"	=> $this -> out_trade_no,			"subject"	=> $this -> name,			"total_fee"	=> $this -> money,			"body"	=> '',			"_input_charset"	=> strtolower('utf-8')		);		$alipay_config['sign_type'] = strtoupper('MD5');		$alipay = new \Common\Util\Alipay\AlipaySubmit($alipay_config);		$html_text = $alipay->buildRequestForm($parameter,"get", "确认");		echo $html_text;	}    // 生活圈付呗预付操作    public function livePrepay()    {        // dump(session('live'));        // dump(I('get.'));        $money               = I('get.money');                $g_uid               = I('get.uid');        $uid                 = session('user.id');        $live['open_id']     = session('live.open_id');        $live['sub_open_id'] = session('live.sub_open_id');        if ($live['open_id'] && $live['sub_open_id'] && $money && $uid && $uid == $g_uid) {            /** 微信公众号支付接口 **/            $data = [                "app_id"        => $GLOBALS['_CFG']['live_pay']['appid'],                "method"        => "openapi.payment.order.h5pay",                "format"        => "json",                "sign_method"   => "md5",                "nonce"         => "livepay"            ];            $content = [                "merchant_order_sn" => date('Ymd') . str_pad(mt_rand(1, 99999), 5, '0', STR_PAD_LEFT),                "open_id"           => $live['open_id'],                "sub_open_id"       => $live['sub_open_id'],                "total_fee"         => $money*1,                "store_id"          => $GLOBALS['_CFG']['live_pay']['storeid'],                "cashier_id"        => null            ];            $data['biz_content']    = json_encode($content);            $result                 = json_decode(\LiveCurl::execute($data, $GLOBALS['_CFG']['live_pay']['appsecret']), true);            session('live', null);            // dump($result);  exit();            // 成功            if ($result['result_code'] == 200) {                // 记录订单表                $add_data = [                    'order_sn'      => $result['data']['merchant_order_sn'],                    'trade_sn'      => $result['data']['order_sn'],                    'prepay_id'     => $result['data']['prepay_id'],                    'userid'        => $uid,                    'total_fee'     => $money,                    'golds'         => $money,                    'detail'        => '充值余额',                    'from'          => 3,                    'ctime'         => $_SERVER['REQUEST_TIME'],                ];                M('pay_order')->add($add_data);                // 跳转支付                $callback_url   = U('Index/index', ['uid' => $uid], '', $_SERVER['HTTP_HOST']);    //支付完成后跳转页面                $cancel_url     = U('Index/index', ['uid' => $uid], '', $_SERVER['HTTP_HOST']);    //支付失败后跳转页面                $pay_url        = \LiveCurl::PAYPAGE ."?prepay_id=". $result['data']['prepay_id'] ."&callback_url=". $callback_url ."&cancel_url=". $cancel_url;                header('location:'. $pay_url);            } else {                $this->error($result['result_message']);             }                    } else {            $this->error('参数错误2');         }    }}?>